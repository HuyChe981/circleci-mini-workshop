version: 2.1


setup: false


orbs:
  continuation: circleci/continuation@0.1.2
  path-filtering: circleci/path-filtering@0.1.1


executors:
  myex:
    docker:
      - image: cimg/ruby:2.7.4
    resource_class: small


commands:
  setup:
    steps:
      - checkout
      - restore_cache:
          key: gem-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
      - run: bundle install
      - save_cache:
          key: gem-cache-v1-{{ arch }}-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle


jobs:


  rubocop:
    executor: myex
    steps:
      - setup
      - run: bundle exec rubocop

  rspec:
    executor: myex
    steps:
      - setup
      - run: bundle exec rspec
      - store_artifacts:
          path: ./coverage


workflows:
  build:
    jobs:
      - path-filtering/filter:
          name: check-changed-path
          mapping: |
            *.js nodejs-changed true
            *.rb ruby-changed true
      - rubocop
      - rspec:
          when: << pipeline.parameters.ruby-changed >>
          requires:
            - rubocop
